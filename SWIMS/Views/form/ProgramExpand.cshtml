@using System.Text.Json


<!-- BACK BUTTON -->
<div style="width: 110px;">
    <a href="##" onClick="history.go(-1); return false;" 
     class="btn rounded-pill btn-outline-dark-1 radius-8 px-20 py-11 d-flex align-items-center gap-2">
        <iconify-icon icon="ion:return-up-back-sharp"></iconify-icon> Back
    </a>
    <br />
    <br />
</div>
<!-- ----------------------------------------------- -->
@{
    ViewData["Title"] = "Program - " + @ViewBag.formName;

    // List of forms that are linking
    // ______________________________
    //
    var linkOption = "";
    @foreach (var inx in ViewBag.formLINK)
    {
        linkOption = "<option>--select--</option><option value="+ inx.uuid +">"+ inx.name +"</option>";
        ViewData["link_UUID"] = inx.uuid;
    }
}

<div class="row">
    <div class="col-sm-12">
        <div class="card radius-12 h-100">
            <div class="card-body py-16 px-24">
                <form asp-action="Create" asp-controller="formTableData">
                    @Html.Raw(@ViewBag.header)
                    <div id="fb-rendered-form"></div>
                    <input type="hidden" name="SW_formsId" value="@ViewBag.formId" />
                    <button type="submit" class="btn btn-success">Submit</button>
                </form>
                
            </div>
        </div>
    </div>

    <!-- LINKING FORM LOGIC ____________________________________________ -->
    <div id="ex5" class="modal">
        <partial name="~/Views/Shared/_CreateLinkingForm.cshtml" view-data="ViewData">        
    </div>
</div>


<link href="~/css/forms-stylesheet.css" rel="stylesheet" />
<script src="~/lib/jquery/dist/jquery.min.js"></script>
<script src="~/lib/formbuilder/form-render.min.js"></script>
<script src="~/lib/fb-logic/formbuilder-conditional-logic.umd.js"></script>

<script src="~/js/datatables.min.js"></script>
<link href="~/lib/trumbowyg-editor/ui/trumbowyg.min.css" rel="stylesheet" />
<script src="~/lib/trumbowyg-editor/trumbowyg.min.js"></script>

<script src="~/lib/jquery-modal/jquery.modal.min.js"></script>
<link href="~/lib/jquery-modal/jquery.modal.min.css" rel="stylesheet" />
<script type="text/javascript">
    // RENDER FORM
    //
    // -----------------------------------------------------------------------------------------------------
    jQuery(function($) {
      var container = document.getElementById('fb-rendered-form');
    const __rawServerValue = @Html.Raw(JsonSerializer.Serialize(ViewBag.form ?? "[]"));

    function normalizeFormData(raw) {
      if (raw == null) return [];
      try {
        if (typeof raw === 'string') {
          const once = JSON.parse(raw);
          return (typeof once === 'string') ? JSON.parse(once) : once;
        }
        return raw;
      } catch (e) {
        console.error('Form JSON parse failed:', e, raw);
        return [];
      }
    }

    const formData = normalizeFormData(__rawServerValue);
    $(container).formRender({ formData: formData, dataType: 'json' });

    if (window.FBConditionalLogic) {
      FBConditionalLogic.setup(container, formData);
    }


    });
    // TABLE DATATABLE INIT
    //
    // -----------------------------------------------------------------------------------------------------
    let table = new DataTable('#dataTable');
    // CUSTOM FORM FUNCTIONALITY
    //
    // -----------------------------------------------------------------------------------------------------
    jQuery(function($) {

        function findFields($root) {

            $root.find("input[name], select[name], textarea[name], input[radio-group]").each(function () {
                var $field = $(this);
                var fieldName = $field.attr("name");
                var fieldName_actual = "";

                if (fieldName.indexOf("Form") >= 0) {
                    // do nothing
                } else {
                    fieldName_actual = fieldName;
                }

                //  Grab classes into an array
                var fieldClasses = ($field.attr("class")).split(/\s+/).filter(c => c.length > 0);

                // Grab ids into an Array
                var fieldIds = ($field.attr("id")).split(/\s+/).filter(c => c.length > 0);

                // If Select Dropdown has field name `linking`
                //
                // 1. hide current Dropdown element
                // 2. infuse WowDash styling Dropdown list
                // 3. inject Form ID with linking check
                // 4. Popup the selected partial view linked form
                //
                if (fieldName === "linking") {
                    $('input[name="linking"]').before("<div class='alert alert-primary bg-primary-50 text-primary-600 border-primary-600 border-start-width-4-px border-top-0 border-end-0 border-bottom-0 px-24 py-13 mb-0 fw-semibold text-lg radius-4 d-flex align-items-center justify-content-between' role='alert'><div class='d-flex align-items-center gap-2'><iconify-icon icon='mdi:form-dropdown' class='icon text-xl'></iconify-icon>ID: </div><br><select id='isLinkingForm' class='form-control'>@Html.Raw(linkOption)</select></div>");
                    $('input[name="linking"]').hide();
                }

                // API LOGIC
                //
                // Traverse all <select> fields (recursively).
                // For each field, check if its name attribute matches a database model (served from an API endpoint).
                // If there’s a match and the field is a <select>, populate it with options from the API response.
                //
                $.ajax({
                    url: window.apiUrl('/api/v1/' + fieldName_actual),
                    method: "GET",
                    dataType: "json",
                    success: function (data) {
                        if (!data) return;

                        // Case 1: Populate select dropdowns
                        if ($field.is("select")) {
                            $field.empty(); // Clear existing options
                            $.each(data, function (i, opt) {
                                var $opt = $("<option>").val(opt.id + "," + opt.uuid + "," + opt.name).text(opt.name);
                                if (data.defaultValue && data.defaultValue == opt.value) {
                                    $opt.prop("selected", true);
                                }
                                $field.append($opt);
                            });
                        }

                        $("select[name="+ fieldName +"]").on("keyup change", function() {

                            var select_list_classVAL = $(this).children("option:selected").val().split(",");

                            if (fieldName === "beneficiary") {
                                $("." + fieldName).val(select_list_classVAL[1]);
                            }
                            if (fieldName === "city") {
                                $("." + fieldName).val(select_list_classVAL[2]);
                            }
                            if (fieldName === "financial_institution") {
                                $("." + fieldName).val(select_list_classVAL[2]);
                            }
                            if (fieldName === "organization") {
                                $("." + fieldName).val(select_list_classVAL[2]);
                            }
                        });


                    },
                    error: function (xhr, status, error) {
                        console.error("Error loading data for " + fieldName + ":", error);
                    }
                });

            });
        }

        // Scope to only inside #fb-rendered-form
        var $formContainer = $("#fb-rendered-form");
        if ($formContainer.length) {
            findFields($formContainer);
        }
    });

    // ------------------------------------------- TINYMCE - WYSWYGET EDITOR
    jQuery(function ($) {
        $(".trumbowyg").trumbowyg({
            btns: [
                ['viewHTML'],
                ['undo', 'redo'], // Only supported in Blink browsers
                ['formatting'],
                ['strong', 'em', 'del'],
                ['superscript', 'subscript'],
                ['link'],
                ['insertImage'],
                ['justifyLeft', 'justifyCenter', 'justifyRight', 'justifyFull'],
                ['unorderedList', 'orderedList'],
                ['horizontalRule'],
                ['removeformat'],
                ['fullscreen']
            ],
            autogrow: true
        });
    });

    // ------------------------------------------- SELECT2 Dropdown
    jQuery(function ($) {
        $('.beneficiary').select2();
        $('.organization').select2();
        $('.financial_institution').select2();
        $('.city').select2();
    });

    jQuery(function ($) {
        $('#isLinkingForm').on('change', function(e) {
              $("#ex5").modal();        
        });
    });
</script>
