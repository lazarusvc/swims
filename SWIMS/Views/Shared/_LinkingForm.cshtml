@using System.Text.Json
@model SWIMS.Models.SW_formTableDatum

<form asp-action="Create" asp-controller="formTableData" method="post" enctype="multipart/form-data">
    @Html.Raw(ViewBag.header)
    <div id="fb-rendered-form-partial"></div>
    <input asp-for="SW_formsId" type="hidden" value="@ViewBag.SW_formsId" />
    <input asp-for="isLinkingForm" type="hidden" value="@ViewBag.isLinkingForm" />
    <button type="submit" class="btn btn-success">Submit</button>
</form>


<link href="~/css/forms-stylesheet.css" rel="stylesheet" />
<script src="~/lib/jquery/dist/jquery.min.js"></script>
<script src="~/lib/formbuilder/form-render.min.js"></script>
<script src="~/lib/fb-logic/formbuilder-conditional-logic.umd.js"></script>
<link href="~/lib/trumbowyg-editor/ui/trumbowyg.min.css" rel="stylesheet" />
<script src="~/lib/trumbowyg-editor/trumbowyg.min.js"></script>
<script type="text/javascript">
    // RENDER FORM
    //
    // -----------------------------------------------------------------------------------------------------
    jQuery(function($) {
      var container = $('#fb-rendered-form-partial');

    // Safely emit the server value as a JS string
    const __rawServerValue = @Html.Raw(JsonSerializer.Serialize(ViewBag.form ?? "[]"));

    // Normalize to an Array the renderer expects (handles double-encoded JSON too)
    function normalizeFormData(raw) {
      if (raw == null) return [];
      try {
        if (typeof raw === 'string') {
          const once = JSON.parse(raw);
          return (typeof once === 'string') ? JSON.parse(once) : once;
        }
        return raw;
      } catch (e) {
        console.error('Form JSON parse failed:', e, raw);
        return [];
      }
    }

    const formData = normalizeFormData(__rawServerValue);

    // Render and hydrate logic
    $(container).formRender({ formData: formData, dataType: 'json' });

    if (window.FBConditionalLogic) {
      FBConditionalLogic.setup(container, formData);
    }

    });
</script>


