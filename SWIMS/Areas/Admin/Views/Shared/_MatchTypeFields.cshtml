@* Reusable partial for both PublicEndpoints and EndpointPolicies Create/Edit views.
   Model is dynamic, but must expose:
   - string MatchType
   - string? Area, Controller, Action, Page, Path, Regex
   - string? Notes
   - bool IsEnabled
   - int Priority *@
@model dynamic
@using SWIMS.Models.Security

<div class="mb-3">
    <label class="form-label">Match Type</label>
    <select name="MatchType" id="mtf-type" class="form-select">
        @foreach (var t in MatchTypes.All)
        {
            var isSelected = string.Equals(Model.MatchType, t, StringComparison.OrdinalIgnoreCase);
            <option value="@t" selected="@(isSelected ? "selected" : null)">@t</option>
        }
    </select>
</div>

<!-- Controller / Action / Area -->
<div class="row g-3 mtf-ca">
    <div class="col-md-4">
        <label class="form-label">Area</label>
        <input name="Area" class="form-control"
               value="@(Model.Area ?? string.Empty)" />
    </div>
    <div class="col-md-4">
        <label class="form-label">Controller</label>
        <input name="Controller" class="form-control"
               value="@(Model.Controller ?? string.Empty)" />
    </div>
    <div class="col-md-4">
        <label class="form-label">Action</label>
        <input name="Action" class="form-control"
               value="@(Model.Action ?? string.Empty)" />
    </div>
</div>

<!-- Razor Page -->
<div class="row g-3 mtf-page d-none">
    <div class="col-md-4">
        <label class="form-label">Area</label>
        <input name="Area" class="form-control"
               value="@(Model.Area ?? string.Empty)" />
    </div>
    <div class="col-md-8">
        <label class="form-label">Razor Page (route)</label>
        <input name="Page" class="form-control"
               value="@(Model.Page ?? string.Empty)"
               placeholder="/Privacy or /Docs/Index" />
    </div>
</div>

<!-- Path -->
<div class="row g-3 mtf-path d-none">
    <div class="col-md-12">
        <label class="form-label">Path</label>
        <input name="Path" class="form-control"
               value="@(Model.Path ?? string.Empty)"
               placeholder="/api/items?id=1" />
    </div>
</div>

<!-- Regex -->
<div class="row g-3 mtf-regex d-none">
    <div class="col-md-12">
        <label class="form-label">Regex</label>
        <input name="Regex" class="form-control"
               value="@(Model.Regex ?? string.Empty)"
               placeholder="^/docs(/.*)?$" />
    </div>
</div>

<!-- Notes + Enabled + Priority -->
<div class="row g-3 mt-3">
    <div class="col-md-8">
        <label class="form-label">Notes</label>
        <input name="Notes" class="form-control"
               value="@(Model.Notes ?? string.Empty)" />
    </div>
    <div class="col-md-2">
        <div class="form-check form-switch mt-4">
            <!-- Hidden ensures a value is always posted -->
            <input type="hidden" name="IsEnabled" value="false" />
            <input type="checkbox"
                   name="IsEnabled"
                   class="form-check-input"
                   value="true"
                   @(Model.IsEnabled ? "checked" : "") />
            <label class="form-check-label">Enabled</label>
        </div>
    </div>
    <div class="col-md-2">
        <label class="form-label">Priority</label>
        <input type="number"
               name="Priority"
               class="form-control"
               value="@(Model.Priority)" />
    </div>
</div>

<script>
    (function () {
        function toggle(el, show) {
            if (!el) return;
            el.classList.toggle('d-none', !show);
        }

        function applyMatchType() {
            var select = document.getElementById('mtf-type');
            if (!select) return;

            var t = select.value;

            var ca = document.querySelector('.mtf-ca');
            var page = document.querySelector('.mtf-page');
            var path = document.querySelector('.mtf-path');
            var regex = document.querySelector('.mtf-regex');

            // Show/hide groups
            toggle(ca, t === 'ControllerAction' || t === 'Controller');
            toggle(page, t === 'RazorPage');
            toggle(path, t === 'Path');
            toggle(regex, t === 'Regex');

            // For MatchType = Controller, hide Controller/Action fields but keep Area
            if (ca) {
                var ctrlCols = ca.querySelectorAll('input[name="Controller"], input[name="Action"]');
                ctrlCols.forEach(function (input) {
                    var col = input.closest('.col-md-4');
                    if (!col) return;
                    col.classList.toggle('d-none', t === 'Controller');
                });
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            var select = document.getElementById('mtf-type');
            if (!select) return;
            applyMatchType();
            select.addEventListener('change', applyMatchType);
        });
    })();
</script>
