<?xml version="1.0" encoding="utf-8"?>
<configuration>

	<!-- Your existing global server-level settings -->
	<system.webServer>
		<security>
			<requestFiltering>
				<!-- Keep this: used by another module -->
				<requestLimits maxQueryString="8192" />
			</requestFiltering>
		</security>
	</system.webServer>

	<!-- Force all /ssrs requests into ASP.NET Core, even if a physical folder exists -->
	<location path="ssrs">
		<system.webServer>

			<!-- Do not let IIS try to list or serve anything under /ssrs -->
			<directoryBrowse enabled="false" />
			<defaultDocument enabled="false">
				<files>
					<clear />
				</files>
			</defaultDocument>

			<!-- Let our app control the response (no IIS custom errors), and allow encoded SSRS paths like %2F -->
			<httpErrors existingResponse="PassThrough" />
			<security>
				<requestFiltering allowDoubleEscaping="true">
					<!-- still keep default protections; just ensure encoded SSRS URLs pass through -->
					<fileExtensions allowUnlisted="true" />
				</requestFiltering>
			</security>

			<!-- Wipe inherited URL Rewrite rules for this path so nothing proxies/loops /ssrs -->
			<rewrite>
				<rules>
					<clear />
				</rules>
			</rewrite>

			<!-- Critical: remove StaticFile/etc. and route EVERYTHING under /ssrs to AspNetCoreModuleV2 -->
			<handlers accessPolicy="Read, Script">
				<clear />
				<add name="aspNetCore-ssrs"
					 path="*"
					 verb="*"
					 modules="AspNetCoreModuleV2"
					 resourceType="Unspecified" />
			</handlers>

			<!-- OPTIONAL: Belt & suspenders. If this causes 500.19 on your IIS, just delete this <modules> block. -->
			<modules runAllManagedModulesForAllRequests="true">
				<remove name="RewriteModule" />
				<!-- URL Rewrite -->
				<remove name="ProxyModule" />
				<!-- ARR proxy module -->
			</modules>

		</system.webServer>
	</location>

</configuration>
